<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Presidential Car Museum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

  <style>
    body {
      background-color: #1f2125; 
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen p-6 text-gray-100">

  <!-- Login Section -->
  <div id="login-section" 
       class="max-w-sm mx-auto mt-20 bg-gray-900 p-8 rounded-2xl shadow-2xl border border-gray-700">
    <!-- Logo Section -->
    <div class="text-center mb-6">
      <img src="museum logo.png" alt="Museum Logo" class="mx-auto h-20 w-auto mb-4">
      <h1 class="text-2xl font-bold text-gray-100">Presidential Car Museum</h1>
    </div>

    <h2 class="text-xl font-semibold mb-6 text-center text-indigo-400"> Admin Login</h2>
    <form onsubmit="login(event)" class="space-y-4">
      <div>
        <label class="block mb-1 text-gray-300 font-medium">Username</label>
        <input type="text" id="username" required 
               class="w-full border border-gray-700 bg-gray-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
      </div>

      <div>
        <label class="block mb-1 text-gray-300 font-medium">Password</label>
        <input type="password" id="password" required 
               class="w-full border border-gray-700 bg-gray-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
      </div>

      <button type="submit" 
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg shadow-lg transition-all">
        Login
      </button>
    </form>
    <p id="login-error" class="text-red-400 mt-4 text-center hidden"> Invalid credentials.</p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
         <div class="flex justify-between items-center mb-8">
       <div class="flex items-center space-x-3">
         <img src="museum logo.png" alt="Museum Logo" class="h-12 w-auto">
         <h1 class="text-3xl font-bold text-white">Admin Dashboard</h1>
       </div>
     </div>

    <div class="flex gap-6">
      <!-- Sidebar -->
      <div class="flex flex-col space-y-3 w-48 bg-gray-900 rounded-xl p-5 shadow-lg border border-gray-700 h-full">
        <button onclick="showTab('home', event)" class="tab-btn bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md flex items-center gap-2">üè† Home</button>
        <button onclick="showTab('students', event)" class="tab-btn text-white hover:bg-gray-800 px-4 py-2 rounded-lg flex items-center gap-2">üë®‚Äçüéì Students</button>
        <button onclick="showTab('visitors', event)" class="tab-btn text-white hover:bg-gray-800 px-4 py-2 rounded-lg flex items-center gap-2">üë• Visitors</button>
        
        <!-- Logout button at bottom -->
        <div class="mt-auto pt-4">
          <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition-all flex items-center gap-2">üö™ Logout</button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 space-y-6">
        <!-- Home -->
        <div id="tab-home" class="tab-content">
          <!-- Stat Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 shadow-lg text-center">
              <h2 class="text-gray-200">Total Students</h2>
              <p class="text-3xl font-extrabold text-white mt-2" id="studentCount">8</p>
            </div>
            <div class="bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-6 shadow-lg text-center">
              <h2 class="text-gray-200">Total Visitors</h2>
              <p class="text-3xl font-extrabold text-white mt-2" id="visitorCount">2</p>
            </div>
            <div class="bg-gradient-to-r from-purple-600 to-purple-800 rounded-xl p-6 shadow-lg text-center">
              <h2 class="text-gray-200">Total Visits</h2>
              <p class="text-3xl font-extrabold text-white mt-2" id="totalCount">10</p>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-md">
              <h2 class="text-gray-200 font-semibold mb-4">Visitor Type Distribution</h2>
              <canvas id="roleChart"></canvas>
            </div>
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-md">
              <h2 class="text-gray-200 font-semibold mb-4">Most Popular Visit Times</h2>
              <canvas id="timeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Students -->
        <div id="tab-students" class="tab-content hidden">
          <div class="bg-gray-900 rounded-xl shadow-lg border border-gray-700 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-700 px-6 py-4">
              <h2 class="text-xl font-bold text-white">Student Visitors</h2>
            </div>
            <div class="p-6 overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-800">
                  <tr>
                    <th class="text-left py-3 px-6 font-semibold text-white">Nickname</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Location</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Visit Time</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Date</th>
                  </tr>
                </thead>
                <tbody id="student-table-body" class="divide-y divide-gray-700 text-white">
                  <!-- dynamic -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Visitors -->
        <div id="tab-visitors" class="tab-content hidden">
          <div class="bg-gray-900 rounded-xl shadow-lg border border-gray-700 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-green-700 px-6 py-4">
              <h2 class="text-xl font-bold text-white">General Visitors</h2>
            </div>
            <div class="p-6 overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-800">
                  <tr>
                    <th class="text-left py-3 px-6 font-semibold text-white">Nickname</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Location</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Visit Time</th>
                    <th class="text-left py-3 px-6 font-semibold text-white">Date</th>
                  </tr>
                </thead>
                <tbody id="visitor-table-body" class="divide-y divide-gray-700 text-white">
                  <!-- dynamic -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3xZaZjQrNRODplN6mXhAzDTHqmRcxYHk",
      authDomain: "presidential-car-museum.firebaseapp.com",
      databaseURL: "https://presidential-car-museum-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "presidential-car-museum",
      storageBucket: "presidential-car-museum.appspot.com",
      messagingSenderId: "888401660663",
      appId: "1:888401660663:web:82b179145c73decfec21f2",
      measurementId: "G-7PWEKQW7ZE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let visitorData = []; 
    let roleChartInstance, timeChartInstance;

    function fetchVisitorData() {
      visitorData = [];

      onValue(ref(db, "students"), (snapshot) => {
        const students = snapshot.val() || {};
        Object.values(students).forEach((s) => {
          visitorData.push({ role: "Student", ...s });
        });
        renderAll();
      });

      onValue(ref(db, "visitors"), (snapshot) => {
        const visitors = snapshot.val() || {};
        Object.values(visitors).forEach((v) => {
          visitorData.push({ role: "Visitor", ...v });
        });
        renderAll();
      });
    }

    function renderAll() {
      updateStatistics();
      populateStudentTable();
      populateVisitorTable();
      drawCharts();
    }

    function updateStatistics() {
      const students = visitorData.filter(v => v.role === "Student").length;
      const visitors = visitorData.filter(v => v.role === "Visitor").length;
      document.getElementById("studentCount").textContent = students;
      document.getElementById("visitorCount").textContent = visitors;
      document.getElementById("totalCount").textContent = students + visitors;
    }

    function populateStudentTable() {
      const tbody = document.getElementById("student-table-body");
      tbody.innerHTML = "";
      const students = visitorData.filter(v => v.role === "Student");
      if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No student visits yet</td></tr>';
        return;
      }
             students.forEach(v => {
         tbody.innerHTML += `
           <tr class="hover:bg-gray-800 transition-colors duration-200">
             <td class="py-4 px-6 text-sm text-white font-medium">${v.nickname || 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.location || 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.visit_time ? new Date(v.visit_time).toLocaleTimeString() : 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.visit_time ? new Date(v.visit_time).toLocaleDateString() : 'N/A'}</td>
           </tr>`;
       });
    }

    function populateVisitorTable() {
      const tbody = document.getElementById("visitor-table-body");
      tbody.innerHTML = "";
      const visitors = visitorData.filter(v => v.role === "Visitor");
      if (visitors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No visitor visits yet</td></tr>';
        return;
      }
             visitors.forEach(v => {
         tbody.innerHTML += `
           <tr class="hover:bg-gray-800 transition-colors duration-200">
             <td class="py-4 px-6 text-sm text-white font-medium">${v.nickname || 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.location || 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.visit_time ? new Date(v.visit_time).toLocaleTimeString() : 'N/A'}</td>
             <td class="py-4 px-6 text-sm text-white">${v.visit_time ? new Date(v.visit_time).toLocaleDateString() : 'N/A'}</td>
           </tr>`;
       });
    }

    function drawCharts() {
      const roleCounts = { Student: 0, Visitor: 0 };
      const timeCounts = {};
      visitorData.forEach(v => {
        roleCounts[v.role]++;
        if (v.visit_time) {
          const hour = new Date(v.visit_time).getHours();
          timeCounts[hour] = (timeCounts[hour] || 0) + 1;
        }
      });

      if (roleChartInstance) roleChartInstance.destroy();
      if (timeChartInstance) timeChartInstance.destroy();

      roleChartInstance = new Chart(document.getElementById("roleChart"), {
        type: 'doughnut',
        data: {
          labels: ['Students', 'Visitors'],
          datasets: [{ data: [roleCounts.Student, roleCounts.Visitor], backgroundColor: ['#3b82f6', '#10b981'], borderWidth: 2, borderColor: '#fff' }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      const sortedHours = Object.keys(timeCounts).sort((a, b) => parseInt(a) - parseInt(b));
      timeChartInstance = new Chart(document.getElementById("timeChart"), {
        type: 'bar',
        data: { labels: sortedHours.map(h => `${h}:00`), datasets: [{ label: 'Number of Visits', data: sortedHours.map(h => timeCounts[h]), backgroundColor: '#6366f1', borderColor: '#4f46e5', borderWidth: 1 }] },
        options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
      });
    }

    // LOGIN + LOGOUT
    window.login = function(event) {
      event.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (username === "admin" && password === "12345") {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        fetchVisitorData();
        document.getElementById("login-error").classList.add("hidden");
      } else {
        document.getElementById("login-error").classList.remove("hidden");
      }
    }

    window.logout = function() {
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("login-section").classList.remove("hidden");
    }

    window.showTab = function(tabId, event) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
      document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("bg-indigo-600","text-white"));
      document.getElementById("tab-" + tabId).classList.remove("hidden");
      event.target.classList.add("bg-indigo-600","text-white");
    }
  </script>
</body>
</html>
