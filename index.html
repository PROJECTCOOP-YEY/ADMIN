<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Presidential Car Museum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>

  <style>
    body {
      background: #0f172a;
      font-family: 'Inter', sans-serif;
    }
    #tab-students canvas, #tab-visitors canvas { display: none; }
    
    /* Loading spinner styles */
    .loading-spinner {
      border: 3px solid #374151;
      border-radius: 50%;
      border-top: 3px solid #6366f1;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <!-- Login Section -->
  <div id="login-section" class="max-w-sm mx-auto mt-24 bg-slate-900/70 backdrop-blur p-8 rounded-2xl shadow-2xl border border-slate-700">
    <div class="text-center mb-6">
      <img src="museum logo.png" alt="Museum Logo" class="mx-auto h-16 w-auto mb-4">
      <h1 class="text-xl font-semibold text-gray-100">Presidential Car Museum</h1>
    </div>


    <h2 class="text-lg font-semibold mb-6 text-center text-indigo-400">Admin Login</h2>
    
    <!-- Connection Status -->
    <div id="connection-status" class="mb-4 p-2 rounded-lg text-center text-sm">
      <span class="text-amber-400">🔄 Connecting to database...</span>
    </div>
    
    <form onsubmit="login(event)" class="space-y-4">
      <div>
        <label class="block mb-1 text-gray-300 font-medium">Username</label>
        <input type="text" id="username" required
               class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
      </div>

      <div>
        <label class="block mb-1 text-gray-300 font-medium">Password</label>
        <input type="password" id="password" required
               class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
      </div>

      <button type="submit" id="login-btn"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg shadow-lg transition-all">
        Login
      </button>
    </form>
    <p id="login-error" class="text-red-400 mt-4 text-center hidden">Invalid credentials.</p>

    <!-- Super Admin Unlock -->
    <div class="mt-4 text-center space-y-2">
      <button id="request-superadmin-btn"
              class="hidden inline-flex items-center px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-sm"
              onclick="requestSuperAdminUnlock()">
        <i class="fas fa-user-shield mr-2"></i>Request Super Admin Unlock
      </button>
      <p id="sa-request-status" class="text-amber-300 text-sm hidden"></p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="bg-slate-900/70 backdrop-blur border-b border-slate-800 sticky top-0 z-50">
      <div class="w-full flex justify-between items-center px-6 py-4">
        <!-- Left: Logo + Title -->
        <div class="flex items-center space-x-4">
          <img src="museum logo.png" alt="Museum Logo" class="h-12 w-auto">
          <h1 class="text-3xl font-bold text-white">Admin Dashboard</h1>
        </div>
    
        <!-- Right: Welcome + Logout -->
        <div class="flex items-center space-x-6">
          <span id="welcome-label" class="text-slate-300 text-sm sm:text-base">Welcome, Admin</span>
          <button onclick="logout()" 
            class="flex items-center bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg transition-all">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </button>
        </div>
      </div>
    </header>    
    
    <!-- Left Sidebar -->
    <aside class="fixed top-[80px] left-0 bottom-0 w-64 bg-slate-900/80 backdrop-white border-r border-slate-800 z-40">
      <div class="px-4 py-6">
        <nav class="flex flex-col space-y-5">
          <button onclick="showTab('home', event)" class="tab-btn bg-indigo-600 text-white hover:bg-slate-800 px-4 py-2 rounded-lg shadow-md flex items-center gap-3">
            <i class="fa-solid fa-house"></i><span>Home</span>
          </button>
          <button onclick="showTab('students', event)" class="tab-btn text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-user-graduate"></i><span>Students</span>
          </button>
          <button onclick="showTab('visitors', event)" class="tab-btn text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-users"></i><span>Visitors</span>
          </button>
          <button id="btn-unlocks" onclick="showTab('unlocks', event)" class="tab-btn hidden text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-lock-open"></i><span>Unlock Requests</span>
          </button>
          <button id="btn-sessions" onclick="showTab('sessions', event)" class="tab-btn hidden text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-user-clock"></i><span>Admin Sessions</span>
          </button>
          <button id="btn-admins" onclick="showTab('admins', event)" class="tab-btn hidden text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-user-gear"></i><span>Manage Admins</span>
          </button>
          <button id="btn-settings" onclick="showTab('settings', event)" class="tab-btn hidden text-slate-200 hover:bg-slate-800 px-4 py-2 rounded-lg flex items-center gap-3">
            <i class="fa-solid fa-cog"></i><span>Super Admin Settings</span>
          </button>
        </nav>
      </div>
    </aside>

    <!-- Main -->
    <main class="max-w-7xl mr-auto px-6 py-8 pl-72">
      <div class="flex gap-6">
        <!-- Content -->
        <section class="flex-1 space-y-8">

          <!-- ==================== HOME TAB ==================== -->
<div id="tab-home" class="tab-content">

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-2">
    <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 rounded-xl p-6 shadow-lg text-center">
      <h3 class="text-indigo-100 text-sm">Total Students</h3>
      <p id="studentCount" class="text-4xl font-extrabold text-white mt-2">0</p>
    </div>
    <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-xl p-6 shadow-lg text-center">
      <h3 class="text-emerald-100 text-sm">Total Visitors</h3>
      <p id="visitorCount" class="text-4xl font-extrabold text-white mt-2">0</p>
    </div>
    <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-6 shadow-lg text-center">
      <h3 class="text-purple-100 text-sm">Total Visits</h3>
      <p id="totalCount" class="text-4xl font-extrabold text-white mt-2">0</p>
    </div>
  </div>

  <!-- Charts row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Role Chart -->
  <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 shadow-md overflow-hidden h-[22rem]">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-slate-100 font-semibold">Visitors by Role</h2>
      <i class="fa-solid fa-users text-slate-400"></i>
    </div>
    <div class="h-[calc(100%-2.5rem)]">
      <canvas id="roleChart" class="w-full h-full block"></canvas>
    </div>
  </div>

  <!-- Time Chart -->
  <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 shadow-md overflow-hidden h-[22rem]">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-slate-100 font-semibold">Visits by Time</h2>
      <i class="fa-solid fa-clock text-slate-400"></i>
    </div>
    <div class="h-[calc(100%-2.5rem)]">
      <canvas id="timeChart" class="w-full h-full block"></canvas>
    </div>
  </div>
</div>

<!-- Weekly Chart (full width at bottom) -->
<div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 shadow-md overflow-hidden h-[26rem] mt-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-slate-100 font-semibold">Visits Per Week</h2>
    <i class="fa-solid fa-calendar-week text-slate-400"></i>
  </div>
  <div class="h-[calc(100%-2.5rem)]">
    <canvas id="dateChart" class="w-full h-full block"></canvas>
  </div>
</div>
</div>
<!-- ================== END HOME TAB ================== -->

<!-- ==================== STUDENTS TAB ==================== -->
<div id="tab-students" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-500 to-indigo-700 px-6 py-4">
      <h2 class="text-lg font-bold text-white">Student Visitors</h2>
    </div>
    <div class="p-6 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-800/80">
          <tr>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Nickname</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Location</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Visit Time</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Date</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Action</th>
          </tr>
        </thead>
        <tbody id="student-table-body" class="divide-y divide-slate-800 text-slate-100">
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ================== END STUDENTS TAB ================== -->

<!-- ==================== VISITORS TAB ==================== -->
<div id="tab-visitors" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-emerald-500 to-emerald-700 px-6 py-4">
      <h2 class="text-lg font-bold text-white">General Visitors</h2>
    </div>
    <div class="p-6 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-800/80">
          <tr>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Nickname</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Location</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Visit Time</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Date</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Action</th>
          </tr>
        </thead>
        <tbody id="visitor-table-body" class="divide-y divide-slate-800 text-slate-100">
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ================== END VISITORS TAB ================== -->

<!-- ==================== MANAGE ADMINS TAB (Super Admin) ==================== -->
<div id="tab-admins" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 px-6 py-4 flex items-center justify-between">
      <h2 class="text-lg font-bold text-white">Manage Admin Accounts</h2>
    </div>
    <div class="p-6 space-y-6">
      <form id="create-admin-form" onsubmit="createAdmin(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block mb-1 text-gray-300 font-medium">Username</label>
          <input type="text" id="new-admin-username" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
        </div>
        <div>
          <label class="block mb-1 text-gray-300 font-medium">Password</label>
          <input type="password" id="new-admin-password" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none" />
        </div>
        <div>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg">Create Admin</button>
        </div>
      </form>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800/80">
            <tr>
              <th class="text-left py-3 px-6 font-semibold text-slate-100">Username</th>
              <th class="text-left py-3 px-6 font-semibold text-slate-100">Created</th>
              <th class="text-left py-3 px-6 font-semibold text-slate-100">Action</th>
            </tr>
          </thead>
          <tbody id="admins-table-body" class="divide-y divide-slate-800 text-slate-100"></tbody>
        </table>
      </div>
    </div>
  </div>
  <p class="text-xs text-slate-400 mt-2 px-1">Note: Super Admin can manage admins only. Passwords are stored in plain text for simplicity. Consider hashing in production.</p>
  
</div>
<!-- ================== END MANAGE ADMINS TAB ================== -->

<!-- ==================== SUPER ADMIN SETTINGS TAB ==================== -->
<div id="tab-settings" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-purple-600 to-purple-800 px-6 py-4">
      <h2 class="text-lg font-bold text-white">Super Admin Settings</h2>
    </div>
    <div class="p-6 space-y-6">
      <!-- Change Username -->
      <div class="bg-slate-800/50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-user-edit mr-3 text-purple-400"></i>Change Username
        </h3>
        <form id="change-username-form" onsubmit="changeSuperAdminUsername(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block mb-1 text-gray-300 font-medium">Current Username</label>
            <input type="text" id="current-username" readonly class="w-full border border-slate-700 bg-slate-700 rounded-lg px-3 py-2 text-gray-300" />
          </div>
          <div>
            <label class="block mb-1 text-gray-300 font-medium">New Username</label>
            <input type="text" id="new-username" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-purple-500 outline-none" />
          </div>
          <div>
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg">Change Username</button>
          </div>
        </form>
      </div>

      <!-- Change Password -->
      <div class="bg-slate-800/50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-key mr-3 text-purple-400"></i>Change Password
        </h3>
        <form id="change-password-form" onsubmit="changeSuperAdminPassword(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 text-gray-300 font-medium">Current Password</label>
            <input type="password" id="current-password" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-purple-500 outline-none" />
          </div>
          <div>
            <label class="block mb-1 text-gray-300 font-medium">New Password</label>
            <input type="password" id="new-password" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-purple-500 outline-none" />
          </div>
          <div>
            <label class="block mb-1 text-gray-300 font-medium">Confirm New Password</label>
            <input type="password" id="confirm-password" required class="w-full border border-slate-700 bg-slate-800 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-purple-500 outline-none" />
          </div>
          <div class="flex items-end">
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg">Change Password</button>
          </div>
        </form>
      </div>

      <!-- Current Account Info -->
      <div class="bg-slate-800/50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-info-circle mr-3 text-purple-400"></i>Account Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-gray-400">Current Username:</span>
            <span id="display-username" class="text-white ml-2 font-mono"></span>
          </div>
          <div>
            <span class="text-gray-400">Account Created:</span>
            <span id="display-created" class="text-white ml-2"></span>
          </div>
          <div>
            <span class="text-gray-400">Last Updated:</span>
            <span id="display-updated" class="text-white ml-2"></span>
          </div>
          <div>
            <span class="text-gray-400">Account Type:</span>
            <span class="text-purple-400 ml-2 font-semibold">Super Administrator</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <p class="text-xs text-slate-400 mt-2 px-1">Note: Changes take effect immediately. You will need to log in again with your new credentials.</p>
</div>
<!-- ================== END SUPER ADMIN SETTINGS TAB ================== -->

<!-- ==================== UNLOCK REQUESTS TAB (Super Admin) ==================== -->
<div id="tab-unlocks" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-amber-500 to-amber-700 px-6 py-4">
      <h2 class="text-lg font-bold text-white">Unlock Requests</h2>
    </div>
    <div class="p-6 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-800/80">
          <tr>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Request ID</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Client</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Username</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Requested At</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Status</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Action</th>
          </tr>
        </thead>
        <tbody id="unlock-req-table-body" class="divide-y divide-slate-800 text-slate-100"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ==================== ADMIN SESSIONS TAB (Super Admin) ==================== -->
<div id="tab-sessions" class="tab-content hidden">
  <div class="bg-slate-900/60 rounded-xl shadow-lg border border-slate-800 overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-500 to-indigo-700 px-6 py-4">
      <h2 class="text-lg font-bold text-white">Admin Sessions</h2>
    </div>
    <div class="p-6 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-800/80">
          <tr>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Session ID</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Username</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Time In</th>
            <th class="text-left py-3 px-6 font-semibold text-slate-100">Time Out</th>
          </tr>
        </thead>
        <tbody id="admin-session-table-body" class="divide-y divide-slate-800 text-slate-100"></tbody>
      </table>
    </div>
  </div>
</div>

        </section>
      </div>

    </main>
  </div>

  <!-- JavaScript -->
  <script type="module">
    // ============================================================================
    // FIREBASE IMPORTS AND CONFIGURATION
    // ============================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove, push, update, get, child, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    // Firebase configuration object
    const firebaseConfig = {
      apiKey: "AIzaSyB3xZaZjQrNRODplN6mXhAzDTHqmRcxYHk",
      authDomain: "presidential-car-museum.firebaseapp.com",
      databaseURL: "https://presidential-car-museum-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "presidential-car-museum",
      storageBucket: "presidential-car-museum.appspot.com",
      messagingSenderId: "888401660663",
      appId: "1:888401660663:web:82b179145c73decfec21f2",
      measurementId: "G-7PWEKQW7ZE"
    };
    
    // Initialize Firebase services
    console.log('Initializing Firebase with config:', firebaseConfig);
    
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      
      console.log('Firebase initialized successfully');
      console.log('Database:', db);
      console.log('Auth:', auth);
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      hideLoadingScreen();
      showError('Failed to initialize Firebase. Please check your configuration.');
    }
    
    // ============================================================================
    // GLOBAL VARIABLES AND STATE MANAGEMENT
    // ============================================================================
    
    // Chart instances for data visualization
    let roleChartInstance, timeChartInstance, dateChartInstance;
    
    // Application state variables
    let combinedData = [];           // Combined student and visitor data
    let isAuthenticated = false;    // Firebase authentication status
    let isAppReady = false;         // App initialization status
    let isSuperAdmin = false;       // Super admin status
    let superAdminIdle = false;    // Super admin idle timeout flag
    let currentUsername = null;    // Current logged-in username
    let currentAdminSessionKey = null; // Current admin session key
    
    // Database references
    const studentsRef = ref(db, 'students');
    const visitorsRef = ref(db, 'visitors');
    const unlockReqsRef = ref(db, 'unlock_requests');
    const adminSessionsRef = ref(db, 'admin_sessions');
    const adminsRef = ref(db, 'admins');
    const superAdminRef = ref(db, 'super_admin');
    
    // ============================================================================
    // AUTHENTICATION AND INITIALIZATION FUNCTIONS
    // ============================================================================
    
    /**
     * Initialize secure Firebase authentication
     * Sets up authentication state listener and handles anonymous sign-in
     */
    function initializeSecureAuth() {
      console.log('Initializing Firebase authentication...');
      updateConnectionStatus('🔄 Connecting to database...', 'amber');
      
      onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed:', user ? 'User authenticated' : 'No user');
        
        if (user) {
          isAuthenticated = true;
          console.log('Authentication successful');
          updateConnectionStatus('✅ Connected to database', 'green');
          if (!isAppReady) {
            initializeDatabaseListeners();
            isAppReady = true;
          }
        } else {
          console.log('No user found, attempting anonymous sign-in...');
          updateConnectionStatus('🔄 Signing in anonymously...', 'amber');
          signInAnonymously(auth)
            .then((userCredential) => {
              console.log('Anonymous sign-in successful:', userCredential.user);
            })
            .catch((error) => {
              console.error('Authentication failed:', error);
              console.error('Error code:', error.code);
              console.error('Error message:', error.message);
              updateConnectionStatus('❌ Connection failed', 'red');
              showError(`Failed to connect to database: ${error.message}. Please check your internet connection and refresh the page.`);
            });
        }
      });
    }
    
    /**
     * Update connection status display
     * @param {string} message - Status message
     * @param {string} color - Color class (amber, green, red)
     */
    function updateConnectionStatus(message, color) {
      const statusEl = document.getElementById('connection-status');
      if (statusEl) {
        statusEl.innerHTML = `<span class="text-${color}-400">${message}</span>`;
      }
    }
    
    /**
     * Hide the loading screen and show login section
     */
    function hideLoadingScreen() {
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
    }
    
    /**
     * Display error message to user
     * @param {string} msg - Error message to display
     */
    function showError(msg) {
      const el = document.getElementById("login-error");
      if (el) {
        el.textContent = msg;
        el.classList.remove("hidden");
      }
    }
    
    // ============================================================================
    // DATABASE OPERATIONS AND LISTENERS
    // ============================================================================
    
    /**
     * Initialize database listeners for real-time data updates
     * Sets up listeners for students, visitors, unlock requests, admin sessions, and admins
     */
    function initializeDatabaseListeners() {
      // Listen for student data changes
      onValue(studentsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const students = Object.entries(data).map(([id, v]) => ({ id, ...v, _path: 'students', _roleNorm: 'student' }));
        combinedData = [...students, ...combinedData.filter(x => x._path !== 'students')];
        refreshUI();
      });

      // Listen for visitor data changes
      onValue(visitorsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const visitors = Object.entries(data).map(([id, v]) => ({ id, ...v, _path: 'visitors', _roleNorm: 'visitor' }));
        combinedData = [...combinedData.filter(x => x._path !== 'visitors'), ...visitors];
        refreshUI();
      });

      // Listen for unlock request changes
      onValue(unlockReqsRef, (snapshot) => {
        populateUnlockRequests(snapshot.val() || {});
      });

      // Listen for admin session changes
      onValue(adminSessionsRef, (snapshot) => {
        populateAdminSessions(snapshot.val() || {});
      });

      // Listen for admin account changes
      onValue(adminsRef, (snapshot) => {
        populateAdmins(snapshot.val() || {});
      });
    }
    
    /**
     * Execute database operation with authentication check
     * @param {Function} operation - Database operation to execute
     * @returns {Promise} - Result of the database operation
     */
    async function secureDbOperation(operation) {
      if (!isAuthenticated) {
        console.warn('Database not ready, waiting for authentication...');
        await new Promise((resolve) => {
          const checkAuth = setInterval(() => {
            if (isAuthenticated) {
              clearInterval(checkAuth);
              resolve();
            }
          }, 100);
        });
      }
      return operation();
    }
    
    /**
     * Refresh the entire UI with current data
     * Updates tables, statistics, and charts
     */
    function refreshUI() {
      populateTables(combinedData);
      updateStatistics(combinedData);
      drawCharts(combinedData);
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * Format timestamp to time string
     * @param {number} ts - Timestamp to format
     * @returns {string} - Formatted time string
     */
    function fmtTime(ts) {
      try { 
        return ts ? new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''; 
      }
      catch { 
        return ''; 
      }
    }
    
    /**
     * Format timestamp to date string
     * @param {number} ts - Timestamp to format
     * @returns {string} - Formatted date string
     */
    function fmtDate(ts) {
      try { 
        return ts ? new Date(ts).toLocaleDateString() : ''; 
      }
      catch { 
        return ''; 
      }
    }
    
    /**
     * Generate SHA-256 hash of text
     * @param {string} text - Text to hash
     * @returns {Promise<string>} - SHA-256 hash
     */
    async function sha256(text) {
      try {
        if (window.crypto?.subtle) {
          const enc = new TextEncoder();
          const data = enc.encode(text);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
      } catch (_) {}
      if (window.sha256) return window.sha256(text);
      throw new Error('No SHA-256 available');
    }
    
    // ============================================================================
    // TABLE AND UI MANAGEMENT FUNCTIONS
    // ============================================================================
    
    /**
     * Populate student and visitor tables with data
     * @param {Array} data - Combined student and visitor data
     */
    function populateTables(data) {
      const studentTable = document.getElementById('student-table-body');
      const visitorTable = document.getElementById('visitor-table-body');
      studentTable.innerHTML = '';
      visitorTable.innerHTML = '';

      // Helper function to identify student entries
      const isStudent = (v) => {
        const r = String(v._roleNorm || v.role || '').toLowerCase();
        return r.startsWith('student');
      };

      // Sort students by visit time (newest first)
      const students = data.filter(isStudent).sort((a, b) => {
        const timeA = a.visit_time ? new Date(a.visit_time).getTime() : 0;
        const timeB = b.visit_time ? new Date(b.visit_time).getTime() : 0;
        return timeB - timeA;
      });
      
      // Sort visitors by visit time (newest first)
      const visitors = data.filter(v => !isStudent(v)).sort((a, b) => {
        const timeA = a.visit_time ? new Date(a.visit_time).getTime() : 0;
        const timeB = b.visit_time ? new Date(b.visit_time).getTime() : 0;
        return timeB - timeA;
      });

      // Populate student table
      students.forEach(v => {
        studentTable.innerHTML += `
          <tr class="hover:bg-slate-800/60 transition-colors">
            <td class="py-3 px-6 text-sm">${v.nickname || ''}</td>
            <td class="py-3 px-6 text-sm">${v.location || ''}</td>
            <td class="py-3 px-6 text-sm">${fmtTime(v.visit_time)}</td>
            <td class="py-3 px-6 text-sm">${fmtDate(v.visit_time)}</td>
            <td class="py-3 px-6 text-sm">
              <button onclick="deleteEntry('students','${v.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
            </td>
          </tr>`;
      });

      // Populate visitor table
      visitors.forEach(v => {
        visitorTable.innerHTML += `
          <tr class="hover:bg-slate-800/60 transition-colors">
            <td class="py-3 px-6 text-sm">${v.nickname || ''}</td>
            <td class="py-3 px-6 text-sm">${v.location || ''}</td>
            <td class="py-3 px-6 text-sm">${fmtTime(v.visit_time)}</td>
            <td class="py-3 px-6 text-sm">${fmtDate(v.visit_time)}</td>
            <td class="py-3 px-6 text-sm">
              <button onclick="deleteEntry('visitors','${v.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
            </td>
          </tr>`;
      });
    }
    
    /**
     * Update statistics display with current data counts
     * @param {Array} data - Combined student and visitor data
     */
    function updateStatistics(data) {
      let students = 0, visitors = 0;
      data.forEach(v => {
        const r = String(v._roleNorm || v.role || '').toLowerCase();
        if (r.startsWith('student')) students++; else visitors++;
      });
      document.getElementById('studentCount').textContent = students;
      document.getElementById('visitorCount').textContent = visitors;
      document.getElementById('totalCount').textContent = students + visitors;
    }
    
    /**
     * Delete an entry from the database
     * @param {string} path - Database path (students or visitors)
     * @param {string} id - Entry ID to delete
     */
    window.deleteEntry = async function(path, id) {
      if (!path || !id) return;
      if (confirm('Delete this entry?')) {
        await secureDbOperation(() => remove(ref(db, `${path}/${id}`)));
      }
    };
    
    // ============================================================================
    // CHART AND VISUALIZATION FUNCTIONS
    // ============================================================================
    
    /**
     * Draw all charts with current data
     * Creates role distribution, time distribution, and weekly visit charts
     * @param {Array} data - Combined student and visitor data
     */
    function drawCharts(data) {
      const roleCounts = { students: 0, visitors: 0 };
      const timeCounts = {};
      const weekCounts = {};

      // Process data for charts
      data.forEach(v => {
        const r = String(v._roleNorm || v.role || '').toLowerCase();
        const isStud = r.startsWith('student');
        roleCounts[isStud ? 'students' : 'visitors'] = (roleCounts[isStud ? 'students' : 'visitors'] || 0) + 1;

        if (v.visit_time) {
          const dt = new Date(v.visit_time);
          const hour = dt.getHours();
          timeCounts[hour] = (timeCounts[hour] || 0) + 1;

          // Calculate week range for weekly chart
          const startOfWeek = new Date(dt);
          startOfWeek.setDate(dt.getDate() - dt.getDay());
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);
          const weekKey = `${startOfWeek.toISOString().slice(0,10)} to ${endOfWeek.toISOString().slice(0,10)}`;
          weekCounts[weekKey] = (weekCounts[weekKey] || 0) + 1;
        }
      });

      // Destroy existing charts before creating new ones
      if (roleChartInstance) roleChartInstance.destroy();
      if (timeChartInstance) timeChartInstance.destroy();
      if (dateChartInstance) dateChartInstance.destroy();
  
      // Create role distribution chart (doughnut)
      roleChartInstance = new Chart(document.getElementById("roleChart"), {
        type: 'doughnut',
        data: {
          labels: ['Students', 'Visitors'],
          datasets: [{
            data: [roleCounts.students || 0, roleCounts.visitors || 0],
            backgroundColor: ['#6366f1', '#10b981'],
            borderWidth: 2,
            borderColor: '#0f172a'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#e5e7eb' } }
          }
        }
      });

      // Create time distribution chart (bar)
      const sortedHours = Object.keys(timeCounts).sort((a, b) => parseInt(a) - parseInt(b));
      timeChartInstance = new Chart(document.getElementById("timeChart"), {
        type: 'bar',
        data: {
          labels: sortedHours.map(h => `${h}:00`),
          datasets: [{
            label: 'Number of Visits',
            data: sortedHours.map(h => timeCounts[h]),
            backgroundColor: '#8b5cf6',
            borderColor: '#7c3aed',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(226,232,240,0.08)' } },
            y: { beginAtZero: true, ticks: { stepSize: 1, color: '#e5e7eb' }, grid: { color: 'rgba(226,232,240,0.08)' } }
          },
          plugins: { legend: { labels: { color: '#e5e7eb' } } }
        }
      });

      // Create weekly visits chart (bar)
      const sortedWeeks = Object.keys(weekCounts).sort((a,b) => {
        const aDate = new Date(a.split(' to ')[0]);
        const bDate = new Date(b.split(' to ')[0]);
        return aDate - bDate;
      });
      dateChartInstance = new Chart(document.getElementById("dateChart"), {
        type: 'bar',
        data: {
          labels: sortedWeeks,
          datasets: [{
            label: 'Visits per Week',
            data: sortedWeeks.map(d => weekCounts[d]),
            backgroundColor: '#f59e0b',
            borderColor: '#d97706',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: '#e5e7eb', autoSkip: true, maxTicksLimit: 8 },
              grid: { color: 'rgba(226,232,240,0.08)' }
            },
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, color: '#e5e7eb' },
              grid: { color: 'rgba(226,232,240,0.08)' }
            }
          },
          plugins: { legend: { labels: { color: '#e5e7eb' } } }
        }
      });
    }
    
    // ============================================================================
    // SECURITY AND LOGIN MANAGEMENT
    // ============================================================================
    
    // Security constants
    const MAX_ATTEMPTS = 3;              // Maximum failed login attempts
    const LOCK_MS = 5 * 60 * 1000;       // Lock duration for regular users (5 minutes)
    const SUPERADMIN_LOCK_MS = 10 * 1000; // Lock duration for super admin (10 seconds)
    
    /**
     * Ensure client ID exists in localStorage
     * Creates a unique client ID if one doesn't exist
     * @returns {string} - Client ID
     */
    function ensureClientId() {
      let id = localStorage.getItem('client_id');
      if (!id) {
        id = `client_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        localStorage.setItem('client_id', id);
      }
      return id;
    }
    const CLIENT_ID = ensureClientId();
    
    /**
     * Get lock expiration timestamp from localStorage
     * @returns {number} - Lock expiration timestamp
     */
    function getLockUntil() {
      const v = localStorage.getItem('admin_lock_until');
      const n = v ? parseInt(v, 10) : 0;
      return isNaN(n) ? 0 : n;
    }
    
    /**
     * Set lock expiration timestamp in localStorage
     * @param {number} ts - Lock expiration timestamp
     */
    function setLockUntil(ts) {
      localStorage.setItem('admin_lock_until', String(ts || 0));
    }
    
    /**
     * Get failed login attempts count from localStorage
     * @returns {number} - Number of failed attempts
     */
    function getAttempts() {
      const v = localStorage.getItem('admin_failed_attempts');
      const n = v ? parseInt(v, 10) : 0;
      return isNaN(n) ? 0 : n;
    }
    
    /**
     * Set failed login attempts count in localStorage
     * @param {number} n - Number of failed attempts
     */
    function setAttempts(n) {
      localStorage.setItem('admin_failed_attempts', String(n || 0));
    }
    
    /**
     * Check if account is currently locked
     * @returns {boolean} - True if account is locked
     */
    function isLocked() {
      return Date.now() < getLockUntil();
    }
    
  /**
   * Lock account for specified duration
   * @param {number} ms - Lock duration in milliseconds
   */
  function lockNow(ms) {
    const duration = typeof ms === 'number' && ms > 0 ? ms : LOCK_MS;
    const lockUntil = Date.now() + duration;
    setLockUntil(lockUntil);
    setAttempts(0);
    
    console.log('Account locked until:', new Date(lockUntil).toLocaleTimeString());
    console.log('Lock duration:', Math.ceil(duration / 1000), 'seconds');
    
    // Start the countdown
    startLockCountdown();
    
    // Fallback: Set a timeout to re-enable login (in case countdown fails)
    setTimeout(() => {
      if (isLocked()) {
        console.log('Fallback: Re-enabling login after lock period');
        setLoginDisabled(false);
        setSuperAdminRequestVisible(false);
        clearError();
      }
    }, duration + 1000); // Add 1 second buffer
  }
  
  /**
   * Start real-time countdown for account lock
   * Updates the error message every second with remaining time
   */
  function startLockCountdown() {
    console.log('Starting lock countdown...');
    
    const updateCountdown = () => {
      try {
        if (!isLocked()) {
          console.log('Lock expired, re-enabling login');
          // Lock expired, re-enable login
          setLoginDisabled(false);
          setSuperAdminRequestVisible(false);
          clearError();
          return;
        }
        
        const remaining = Math.max(0, getLockUntil() - Date.now());
        const totalSeconds = Math.ceil(remaining / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        
        let timeString;
        if (minutes > 0) {
          timeString = `${minutes}m ${seconds}s`;
        } else {
          timeString = `${seconds}s`;
        }
        
        console.log('Countdown update:', timeString);
        showError(`Invalid credentials. Account locked for ${timeString}`);
        
        // Continue countdown
        setTimeout(updateCountdown, 1000);
      } catch (error) {
        console.error('Countdown error:', error);
        // Fallback: just show a generic message
        showError('Invalid credentials. Account locked. Please refresh the page.');
      }
    };
    
    // Start the countdown
    updateCountdown();
  }
    
    /**
     * Clear error message display
     */
    function clearError() {
      const el = document.getElementById("login-error");
      if (el) el.classList.add("hidden");
    }
    
    /**
     * Enable or disable login form elements
     * @param {boolean} disabled - True to disable, false to enable
     */
    function setLoginDisabled(disabled) {
      const u = document.getElementById("username");
      const p = document.getElementById("password");
      const b = document.getElementById("login-btn");
      if (u) u.disabled = disabled;
      if (p) p.disabled = disabled;
      if (b) b.disabled = disabled;
    }
  
  if (isLocked()) {
    const remaining = Math.max(0, getLockUntil() - Date.now());
    const secs = Math.ceil(remaining / 1000);
    showError(`Invalid credentials. Account locked for ${secs} seconds`);
    setLoginDisabled(true);
    setSuperAdminRequestVisible(true);
    watchMyUnlockRequest();
  } else {
    setLoginDisabled(false);
    setSuperAdminRequestVisible(false);
    setRequestStatus('');
  }
  
  let idleTimeoutId = null;
  let activityHandlersBound = false;
  
  function getIdleMs() {
    return superAdminIdle ? (10 * 1000) : (10 * 60 * 1000);
  }
  
  function handleInactivityLogout() {
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("login-section").classList.remove("hidden");
    const el = document.getElementById("login-error");
    if (el) {
      el.textContent = "Session timed out due to inactivity. Please log in again.";
      el.classList.remove("hidden");
    }
    endAdminSession();
    stopIdleWatch();
  }
  
  function resetIdleTimer() {
    if (idleTimeoutId) clearTimeout(idleTimeoutId);
    idleTimeoutId = setTimeout(handleInactivityLogout, getIdleMs());
  }
  
  function bindActivityHandlers() {
    if (activityHandlersBound) return;
    activityHandlersBound = true;
    const reset = resetIdleTimer;
    window.addEventListener("mousemove", reset);
    window.addEventListener("mousedown", reset);
    window.addEventListener("keydown", reset);
    window.addEventListener("scroll", reset, { passive: true });
    window.addEventListener("touchstart", reset, { passive: true });
    window.addEventListener("click", reset);
  }
  
  function unbindActivityHandlers() {
    if (!activityHandlersBound) return;
    activityHandlersBound = false;
    const reset = resetIdleTimer;
    window.removeEventListener("mousemove", reset);
    window.removeEventListener("mousedown", reset);
    window.removeEventListener("keydown", reset);
    window.removeEventListener("scroll", reset);
    window.removeEventListener("touchstart", reset);
    window.removeEventListener("click", reset);
  }
  
  function startIdleWatch() {
    bindActivityHandlers();
    resetIdleTimer();
  }
  
  function stopIdleWatch() {
    if (idleTimeoutId) {
      clearTimeout(idleTimeoutId);
      idleTimeoutId = null;
    }
    unbindActivityHandlers();
  }
  
  function setSuperAdminRequestVisible(show) {
    const btn = document.getElementById('request-superadmin-btn');
    if (btn) (show ? btn.classList.remove('hidden') : btn.classList.add('hidden'));
  }
  
  function setRequestStatus(msg, tone = 'info') {
    const el = document.getElementById('sa-request-status');
    if (!el) return;
    if (!msg) { el.classList.add('hidden'); return; }
    el.textContent = msg;
    el.classList.remove('hidden');
    el.classList.remove('text-amber-300','text-green-300','text-red-400');
    if (tone === 'ok') el.classList.add('text-green-300');
    else if (tone === 'err') el.classList.add('text-red-400');
    else el.classList.add('text-amber-300');
  }
  
  async function requestSuperAdminUnlock() {
    try {
      const attemptedUsername = (document.getElementById("username")?.value || "").trim();
      const reqsSnap = await secureDbOperation(() => get(child(ref(db), 'unlock_requests')));
      let existingId = null;
      const now = Date.now();
      if (reqsSnap.exists()) {
        const all = reqsSnap.val();
        for (const [id, r] of Object.entries(all)) {
          if (r && r.clientId === CLIENT_ID && r.status === 'pending') {
            existingId = id;
            if (attemptedUsername && r.username !== attemptedUsername) {
              await secureDbOperation(() => update(ref(db, `unlock_requests/${id}`), { username: attemptedUsername }));
            }
            break;
          }
        }
      }
      if (!existingId) {
        const newRef = await secureDbOperation(() => push(ref(db, 'unlock_requests'), {
          clientId: CLIENT_ID,
          username: attemptedUsername || null,
          requestedAt: now,
          status: 'pending'
        }));
        existingId = newRef.key;
      }
      localStorage.setItem('unlock_request_id', existingId);
      setRequestStatus('Request sent. Waiting for Super Admin approval…');
      watchMyUnlockRequest();
    } catch (e) {
      setRequestStatus('Failed to send request. Please try again.', 'err');
      console.error(e);
    }
  }
  
  let myReqUnsub = null;
  let superAdminUsername = null;
  onValue(superAdminRef, (snap) => {
    const v = snap.val();
    superAdminUsername = (v?.username || '').trim();
  });
  
  function watchMyUnlockRequest() {
    const id = localStorage.getItem('unlock_request_id');
    if (!id) return;
    if (myReqUnsub) myReqUnsub();
    const reqRef = ref(db, `unlock_requests/${id}`);
    const off = onValue(reqRef, (snap) => {
      const r = snap.val();
      if (!r) return;
      if (r.status === 'approved') {
        setLockUntil(0);
        setAttempts(0);
        setLoginDisabled(false);
        setSuperAdminRequestVisible(false);
        setRequestStatus('Unlock approved. Redirecting…', 'ok');
  
        const login = document.getElementById("login-section");
        const dash = document.getElementById("dashboard");
        if (login && dash) {
          login.classList.add("hidden");
          dash.classList.remove("hidden");
          startIdleWatch();
          setActiveTabButton(document.querySelector(".tab-btn"));
          document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
          const home = document.getElementById("tab-home");
          if (home) home.classList.remove("hidden");
          clearError();
          setTimeout(() => {
            if (roleChartInstance) roleChartInstance.resize?.();
            if (timeChartInstance) timeChartInstance.resize?.();
            if (dateChartInstance) dateChartInstance.resize?.();
          }, 50);
          startAdminSession();
          localStorage.removeItem('unlock_request_id');
        }
      } else if (r.status === 'rejected') {
        setRequestStatus('Super Admin rejected the unlock request.', 'err');
      } else {
        setRequestStatus('Request pending approval…');
      }
    });
    myReqUnsub = () => off();
  }
  
  async function approveRequest(id) {
    if (!requireSuperAdmin()) return;
    await secureDbOperation(() => update(ref(db, `unlock_requests/${id}`), {
      status: 'approved',
      approvedAt: Date.now()
    }));
  }
  
  async function rejectRequest(id) {
    if (!requireSuperAdmin()) return;
    await secureDbOperation(() => update(ref(db, `unlock_requests/${id}`), {
      status: 'rejected',
      rejectedAt: Date.now()
    }));
  }
  
  function populateUnlockRequests(all) {
    const body = document.getElementById('unlock-req-table-body');
    if (!body) return;
    body.innerHTML = '';
    const entries = Object.entries(all || {}).sort((a,b) => (b[1]?.requestedAt||0) - (a[1]?.requestedAt||0));
    entries.forEach(([id, r]) => {
      const when = r?.requestedAt ? new Date(r.requestedAt).toLocaleString() : '';
      const actions = r?.status === 'pending'
        ? `<button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded mr-2" onclick="approveRequest('${id}')">Approve</button>
           <button class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded" onclick="rejectRequest('${id}')">Reject</button>`
        : `<span class="text-slate-300">—</span>`;
      body.innerHTML += `
        <tr class="hover:bg-slate-800/60 transition-colors">
          <td class="py-3 px-6 text-sm">${id}</td>
          <td class="py-3 px-6 text-sm">${r?.clientId || ''}</td>
          <td class="py-3 px-6 text-sm">${r?.username || ''}</td>
          <td class="py-3 px-6 text-sm">${when}</td>
          <td class="py-3 px-6 text-sm">${(r?.status||'').toUpperCase()}</td>
          <td class="py-3 px-6 text-sm">${actions}</td>
        </tr>`;
    });
  }
  
  let adminAccountUnsub = null;
  
  async function startAdminSession() {
    try {
      const res = await secureDbOperation(() => push(ref(db, 'admin_sessions'), { admin: (currentUsername || 'admin'), timeIn: Date.now(), timeOut: null }));
      currentAdminSessionKey = res.key;
    } catch(e) { console.error(e); }
  }
  
  async function endAdminSession() {
    try {
      if (!currentAdminSessionKey) return;
      await secureDbOperation(() => update(ref(db, `admin_sessions/${currentAdminSessionKey}`), { timeOut: Date.now() }));
      currentAdminSessionKey = null;
    } catch(e) { console.error(e); }
  }
  
  function populateAdminSessions(all) {
    const body = document.getElementById('admin-session-table-body');
    if (!body) return;
    body.innerHTML = '';
    const entries = Object.entries(all || {}).sort((a,b) => (b[1]?.timeIn||0) - (a[1]?.timeIn||0));
    entries.forEach(([id, s]) => {
      const tIn = s?.timeIn ? new Date(s.timeIn).toLocaleString() : '';
      const tOut = s?.timeOut ? new Date(s.timeOut).toLocaleString() : '—';
      body.innerHTML += `
        <tr class="hover:bg-slate-800/60 transition-colors">
          <td class="py-3 px-6 text-sm">${id}</td>
          <td class="py-3 px-6 text-sm">${s?.admin || 'admin'}</td>
          <td class="py-3 px-6 text-sm">${tIn}</td>
          <td class="py-3 px-6 text-sm">${tOut}</td>
        </tr>`;
    });
  }
  
  window.requestSuperAdminUnlock = requestSuperAdminUnlock;
  window.approveRequest = approveRequest;
  window.rejectRequest = rejectRequest;
  
  
  function toggleApproverTabs(show) {
    const b1 = document.getElementById('btn-unlocks');
    const b2 = document.getElementById('btn-sessions');
    const b3 = document.getElementById('btn-admins');
    const b4 = document.getElementById('btn-settings');
    if (b1) b1.classList[show ? 'remove' : 'add']('hidden');
    if (b2) b2.classList[show ? 'remove' : 'add']('hidden');
    if (b3) b3.classList[show ? 'remove' : 'add']('hidden');
    if (b4) b4.classList[show ? 'remove' : 'add']('hidden');
    if (!show) {
      const t1 = document.getElementById('tab-unlocks');
      const t2 = document.getElementById('tab-sessions');
      const t3 = document.getElementById('tab-admins');
      const t4 = document.getElementById('tab-settings');
      if (t1) t1.classList.add('hidden');
      if (t2) t2.classList.add('hidden');
      if (t3) t3.classList.add('hidden');
      if (t4) t4.classList.add('hidden');
    }
  }
  
  function requireSuperAdmin() {
    if (!isSuperAdmin) {
      alert('Super Admin only.');
      return false;
    }
    return true;
  }
  
  function watchOwnAdminAccount(username) {
    if (!username) return;
    if (adminAccountUnsub) { adminAccountUnsub(); adminAccountUnsub = null; }
    const accRef = ref(db, `admins/${username}`);
    const off = onValue(accRef, (snap) => {
      if (!snap.exists()) {
        alert('Your admin account was deleted. You will be logged out.');
        logout();
      }
    });
    adminAccountUnsub = () => off();
  }
  
  function populateAdmins(all) {
    const body = document.getElementById('admins-table-body');
    if (!body) return;
    body.innerHTML = '';
    const entries = Object.entries(all || {}).sort((a,b) => (b[1]?.createdAt||0) - (a[1]?.createdAt||0));
    entries.forEach(([username, rec]) => {
      const created = rec?.createdAt ? new Date(rec.createdAt).toLocaleString() : '';
      body.innerHTML += `
        <tr class="hover:bg-slate-800/60 transition-colors">
          <td class="py-3 px-6 text-sm">${username}</td>
          <td class="py-3 px-6 text-sm">${created}</td>
          <td class="py-3 px-6 text-sm">
            <button class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded" onclick="deleteAdmin('${username}')">Delete</button>
          </td>
        </tr>`;
    });
  }
  
  async function createAdmin(event) {
    event?.preventDefault?.();
    if (!requireSuperAdmin()) return;
    const usernameEl = document.getElementById('new-admin-username');
    const passwordEl = document.getElementById('new-admin-password');
    const username = (usernameEl?.value || '').trim();
    const password = (passwordEl?.value || '').trim();
    if (!username || !password) { alert('Enter username and password'); return; }
    if (username.toLowerCase() === 'superadmin') { alert('Reserved username.'); return; }
    try {
      const snap = await secureDbOperation(() => get(child(ref(db), `admins/${username}`)));
      if (snap.exists()) { alert('Username already exists.'); return; }
      const passwordHash = await sha256(password);
      await secureDbOperation(() => set(ref(db, `admins/${username}`), { passwordHash, createdAt: Date.now() }));
      if (passwordEl) passwordEl.value = '';
    alert('Admin created.');
  } catch (e) {
    console.error(e);
    alert('Failed to create admin');
  }
}

async function deleteAdmin(username) {
  if (!requireSuperAdmin()) return;
  if (!username) return;
  if (!confirm(`Delete admin "${username}"?`)) return;
  try {
    await secureDbOperation(() => remove(ref(db, `admins/${username}`)));
  } catch (e) {
    console.error(e);
    alert('Failed to delete admin');
  }
}

window.login = async function(event) {
  event.preventDefault();

  // Check if Firebase is ready
  if (!isAuthenticated) {
    showError("Please wait, connecting to database...");
    return;
  }

  if (isLocked()) {
    startLockCountdown();
    setLoginDisabled(true);
    setSuperAdminRequestVisible(true);
    watchMyUnlockRequest();
    return;
  }

  const username = document.getElementById("username").value.trim();
  let password = document.getElementById("password").value;
  if (typeof password === 'string') password = password.trim();

  console.log('=== LOGIN ATTEMPT ===');
  console.log('Username:', username);
  console.log('Password length:', password.length);
  console.log('Firebase authenticated:', isAuthenticated);

  let isSuper = false;
  try {
    console.log('Checking super admin...');
    const saSnap = await secureDbOperation(() => get(superAdminRef));
    if (saSnap.exists()) {
      const sa = saSnap.val();
      const expectedUser = (sa?.username || '').trim();
      const expectedHash = (sa?.passwordHash || '').trim().toLowerCase();
      
      console.log('Super admin data found:');
      console.log('- Expected username:', expectedUser);
      console.log('- Expected hash:', expectedHash);
      console.log('- Username match:', username === expectedUser);
      
      if (username === expectedUser) {
        const hash = (await sha256(password)).toLowerCase();
        console.log('- Input hash:', hash);
        console.log('- Hash match:', hash === expectedHash);
        if (hash === expectedHash) {
          isSuper = true;
          console.log('✅ Super admin login successful!');
        }
      }
    } else {
      console.log('Superadmin not found in database. Creating default superadmin...');
      const defaultPassword = 'superadmin123';
      const defaultHash = (await sha256(defaultPassword)).toLowerCase();
      await secureDbOperation(() => set(superAdminRef, {
        username: 'superadmin',
        passwordHash: defaultHash,
        createdAt: Date.now()
      }));
      console.log('Default superadmin created: username="superadmin", password="superadmin123"');
      
      if (username === 'superadmin' && password === defaultPassword) {
        isSuper = true;
        console.log('✅ Default super admin login successful!');
      } else {
        showError('Superadmin account created! Use: username="superadmin", password="superadmin123"');
        return;
      }
    }
  } catch (e) { 
    console.error('Super admin check failed:', e); 
  }
  
  let isAdmin = false;
  if (!isSuper) {
    try {
      console.log('Checking regular admin...');
      const adminSnap = await secureDbOperation(() => get(child(ref(db), `admins/${username}`)));
      if (adminSnap.exists()) {
        const rec = adminSnap.val();
        console.log('Admin data found:', rec);
        
        if (rec?.passwordHash) {
          const hash = await sha256(password);
          console.log('- Input hash:', hash);
          console.log('- Stored hash:', rec.passwordHash);
          console.log('- Hash match:', hash === rec.passwordHash);
          if (hash === rec.passwordHash) {
            isAdmin = true;
            console.log('✅ Admin login successful!');
          }
        } else if ((rec?.password || '') === password) {
          isAdmin = true;
          console.log('✅ Admin login successful (legacy password)!');
          try {
            const newHash = await sha256(password);
            await secureDbOperation(() => update(ref(db, `admins/${username}`), { passwordHash: newHash }));
            await secureDbOperation(() => update(ref(db, `admins/${username}`), { password: null }));
          } catch (e) { console.error('Admin password migration failed:', e); }
        }
      } else {
        console.log('No admin account found for username:', username);
      }
    } catch (e) { 
      console.error('Admin check failed:', e); 
    }
  }

  console.log('=== LOGIN RESULT ===');
  console.log('Is Super Admin:', isSuper);
  console.log('Is Regular Admin:', isAdmin);
  console.log('Login Success:', isAdmin || isSuper);

  if (isAdmin || isSuper) {
    setAttempts(0);
    setLockUntil(0);

    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");

    startIdleWatch();

    setActiveTabButton(document.querySelector(".tab-btn"));
    document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
    document.getElementById("tab-home").classList.remove("hidden");

    clearError();
    setTimeout(() => {
      if (roleChartInstance) roleChartInstance.resize?.();
      if (timeChartInstance) timeChartInstance.resize?.();
      if (dateChartInstance) dateChartInstance.resize?.();
    }, 50);

    currentUsername = isSuper ? 'superadmin' : username;
    if (isAdmin) {
      startAdminSession();
      watchOwnAdminAccount(username);
    }

    isSuperAdmin = isSuper;
    superAdminIdle = isSuper;
    toggleApproverTabs(isSuper);
    
    if (isSuper) {
      updateSuperAdminDisplay();
    }

  } else {
    console.log('❌ Login failed - Invalid credentials');
    const attempts = getAttempts() + 1;
    console.log('Failed attempts:', attempts, 'of', MAX_ATTEMPTS);
    
    if (attempts >= MAX_ATTEMPTS) {
      console.log('Account will be locked after', attempts, 'failed attempts');
      const isSuperAttempt = (username === superAdminUsername && superAdminUsername);
      const lockMs = isSuperAttempt ? SUPERADMIN_LOCK_MS : LOCK_MS;
      lockNow(lockMs);
      setLoginDisabled(true);
      setSuperAdminRequestVisible(true);
      watchMyUnlockRequest();
    } else {
      setAttempts(attempts);
      showError("Invalid credentials.");
    }
  }
}

window.logout = function() {
  stopIdleWatch();
  superAdminIdle = false;
  isSuperAdmin = false;
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("login-section").classList.remove("hidden");
  endAdminSession();
  setRequestStatus('');
  toggleApproverTabs(false);
  if (adminAccountUnsub) { adminAccountUnsub(); adminAccountUnsub = null; }
  currentUsername = null;
}

function setActiveTabButton(btn) {
  document.querySelectorAll(".tab-btn").forEach(el => {
    el.classList.remove("bg-indigo-600","text-white","shadow-md");
    el.classList.add("text-slate-200");
    el.removeAttribute("aria-current");
  });
  if (btn) {
    btn.classList.add("bg-indigo-600","text-white","shadow-md");
    btn.setAttribute("aria-current","page");
  }
}

window.showTab = function(tabId, event) {
  const targetBtn = event?.currentTarget || event?.target?.closest?.(".tab-btn");

  document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
  const el = document.getElementById("tab-" + tabId);
  if (el) el.classList.remove("hidden");
  setActiveTabButton(targetBtn);

  if (tabId === 'home') {
    if (roleChartInstance) roleChartInstance.resize();
    if (timeChartInstance) timeChartInstance.resize();
    if (dateChartInstance) dateChartInstance.resize();
  }
  superAdminIdle = (tabId === 'settings');
  resetIdleTimer();
}

window.createAdmin = createAdmin;
window.deleteAdmin = deleteAdmin;

async function changeSuperAdminUsername(event) {
  event.preventDefault();
  if (!requireSuperAdmin()) return;
  
  const newUsername = document.getElementById('new-username').value.trim();
  if (!newUsername) {
    alert('Please enter a new username');
    return;
  }
  
  if (newUsername.toLowerCase() === 'superadmin') {
    alert('Cannot use "superadmin" as username');
    return;
  }
  
  try {
    const saSnap = await secureDbOperation(() => get(superAdminRef));
    if (!saSnap.exists()) {
      alert('Superadmin account not found');
      return;
    }
    
    await secureDbOperation(() => update(superAdminRef, {
      username: newUsername,
      updatedAt: Date.now()
    }));
    
    alert(`Username changed successfully to "${newUsername}". You will need to log in again.`);
    
    document.getElementById('new-username').value = '';
    updateSuperAdminDisplay();
    
    setTimeout(() => {
      logout();
    }, 2000);
    
  } catch (e) {
    console.error(e);
    alert('Failed to change username');
  }
}

async function changeSuperAdminPassword(event) {
  event.preventDefault();
  if (!requireSuperAdmin()) return;
  
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  
  if (!currentPassword || !newPassword || !confirmPassword) {
    alert('Please fill in all password fields');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('New passwords do not match');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('New password must be at least 6 characters long');
    return;
  }
  
  try {
    const saSnap = await secureDbOperation(() => get(superAdminRef));
    if (!saSnap.exists()) {
      alert('Superadmin account not found');
      return;
    }
    
    const currentData = saSnap.val();
    const currentHash = (currentData?.passwordHash || '').trim().toLowerCase();
    
    const inputHash = (await sha256(currentPassword)).toLowerCase();
    if (inputHash !== currentHash) {
      alert('Current password is incorrect');
      return;
    }
    
    const newHash = (await sha256(newPassword)).toLowerCase();
    await secureDbOperation(() => update(superAdminRef, {
      passwordHash: newHash,
      updatedAt: Date.now()
    }));
    
    alert('Password changed successfully. You will need to log in again.');
    
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
    
    updateSuperAdminDisplay();
    
    setTimeout(() => {
      logout();
    }, 2000);
    
  } catch (e) {
    console.error(e);
    alert('Failed to change password');
  }
}

async function updateSuperAdminDisplay() {
  try {
    const saSnap = await secureDbOperation(() => get(superAdminRef));
    if (saSnap.exists()) {
      const data = saSnap.val();
      const username = data?.username || 'superadmin';
      const createdAt = data?.createdAt ? new Date(data.createdAt).toLocaleString() : 'Unknown';
      const updatedAt = data?.updatedAt ? new Date(data.updatedAt).toLocaleString() : 'Never';
      
      document.getElementById('current-username').value = username;
      document.getElementById('display-username').textContent = username;
      document.getElementById('display-created').textContent = createdAt;
      document.getElementById('display-updated').textContent = updatedAt;
    }
  } catch (e) {
    console.error('Failed to update superadmin display:', e);
  }
}

window.changeSuperAdminUsername = changeSuperAdminUsername;
window.changeSuperAdminPassword = changeSuperAdminPassword;

    
    // ============================================================================
    // APPLICATION INITIALIZATION
    // ============================================================================
    
    /**
     * Initialize the application
     * Sets up authentication and starts the app
     */
    function initializeApplication() {
      console.log('Starting application initialization...');
      
      // Set a timeout to prevent infinite loading
      const loadingTimeout = setTimeout(() => {
        console.error('Authentication timeout - taking too long to connect');
        updateConnectionStatus('⏰ Connection timeout', 'red');
        showError('Connection timeout. Please check your internet connection and refresh the page.');
      }, 15000); // 15 second timeout
      
      // Check if account is locked on page load
  if (isLocked()) {
    startLockCountdown();
    setLoginDisabled(true);
    setSuperAdminRequestVisible(true);
    watchMyUnlockRequest();
    clearTimeout(loadingTimeout);
  } else {
    setLoginDisabled(false);
    setSuperAdminRequestVisible(false);
    setRequestStatus('');
  }
      
      // Initialize secure authentication
      initializeSecureAuth();
      
      // Clear timeout when authentication succeeds
      const originalUpdateStatus = updateConnectionStatus;
      updateConnectionStatus = function(message, color) {
        if (color === 'green') {
          clearTimeout(loadingTimeout);
        }
        originalUpdateStatus(message, color);
      };
    }
    
    // Start the application
    initializeApplication();
    
    // Test function for debugging timer (remove in production)
    window.testTimer = function() {
      console.log('Testing timer...');
      lockNow(10000); // Lock for 10 seconds for testing
    };
    
    // ============================================================================
    // END OF JAVASCRIPT MODULE
    // ============================================================================
  </script>  
</body>
</html>
